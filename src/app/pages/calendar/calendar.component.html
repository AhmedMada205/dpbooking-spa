<div class="calendar-dashboard">
  <!-- Header Section -->
  <div class="calendar-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="page-title mb-1">
          <i class="fa fa-calendar"></i>
          تقويم الحجوزات
        </h1>
        <p class="text-muted">عرض الحجوزات الشهري واليومي بشكل منظم</p>
      </div>
      
      <div class="header-controls">
        <div class="month-navigation">
          <button class="btn btn-outline-secondary btn-sm" (click)="previousMonth()">
            <i class="fa fa-chevron-right"></i> السابق
          </button>
          <span class="current-month">{{ monthName }} {{ currentYear }}</span>
          <button class="btn btn-outline-secondary btn-sm" (click)="nextMonth()">
            التالي <i class="fa fa-chevron-left"></i>
          </button>
          <button class="btn btn-outline-primary btn-sm ms-2" (click)="goToToday()">
            <i class="fa fa-calendar"></i> اليوم
          </button>
        </div>
        
        <div class="view-actions mt-2">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-primary">
              <i class="fa fa-calendar"></i> شهري
            </button>
            <button class="btn btn-outline-secondary">
              <i class="fa fa-list"></i> أسبوعي
            </button>
            <button class="btn btn-outline-secondary">
              <i class="fa fa-sun-o"></i> يومي
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Summary -->
  <div class="stats-summary" *ngIf="!loading">
    <div class="row">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card total-bookings">
          <div class="stat-icon">
            <i class="fa fa-calendar-check-o"></i>
          </div>
          <div class="stat-content">
            <h3>{{ totalBookings }}</h3>
            <p>إجمالي الحجوزات</p>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card confirmed-bookings">
          <div class="stat-icon">
            <i class="fa fa-check-circle"></i>
          </div>
          <div class="stat-content">
            <h3>{{ confirmedBookings }}</h3>
            <p>حجوزات مؤكدة</p>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card pending-bookings">
          <div class="stat-icon">
            <i class="fa fa-clock-o"></i>
          </div>
          <div class="stat-content">
            <h3>{{ pendingBookings }}</h3>
            <p>قيد الانتظار</p>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="stat-card revenue">
          <div class="stat-icon">
            <i class="fa fa-money"></i>
          </div>
          <div class="stat-content">
            <h3>{{ totalRevenue | number:'1.0-0' }}</h3>
            <p>إجمالي الإيرادات (ج.م)</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div class="text-center py-5" *ngIf="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">جاري التحميل...</span>
    </div>
    <p class="mt-2">جاري تحميل الحجوزات...</p>
  </div>

  <!-- Calendar Grid -->
  <div class="calendar-container" *ngIf="!loading">
    <!-- Week Days Header -->
    <div class="calendar-week-header">
      <div *ngFor="let day of weekDays" class="week-day" [ngClass]="day.class">
        {{ day.name }}
      </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
      <div *ngFor="let day of daysInMonth" 
           class="calendar-day" 
           [ngClass]="{
             'empty': day.isEmpty,
             'today': day.isToday,
             'weekend': day.isWeekend,
             'has-bookings': day.bookings?.length > 0,
             'selected': selectedDate && day.date && selectedDate.toDateString() === day.date.toDateString()
           }"
           (click)="selectDay(day)">
        
        <!-- أيام الشهر السابق/التالي (فارغة) -->
        <ng-container *ngIf="day.isEmpty">
          <div class="day-header">
            <span class="day-number">{{ day.dayNumber }}</span>
          </div>
        </ng-container>

        <!-- أيام الشهر الحالي -->
        <ng-container *ngIf="!day.isEmpty">
          <div class="day-header">
            <span class="day-number">{{ day.dayNumber }}</span>
            <span class="day-name" *ngIf="day.dayNumber === 1">{{ monthName }}</span>
            <span class="today-badge" *ngIf="day.isToday">اليوم</span>
          </div>
          
          <div class="day-content">
            <!-- عرض أول 3 حجوزات كحد أقصى -->
            <div *ngFor="let booking of day.bookings | slice:0:2" 
                 class="booking-item" 
                 [ngClass]="getStatusClass(booking.bookingStatus)"
                 (click)="$event.stopPropagation(); goToBookingDetails(booking.bookingId)">
              <span class="booking-time">{{ formatTime(booking.bookingTime) }}</span>
              <span class="booking-client-name">{{ booking.clientName || 'غير محدد' }}</span>
              <span class="booking-title">{{ getBookingTypeText(booking.bookingType) }}</span>
              <span class="booking-guests">{{ booking.guestsCount }} شخص</span>
            </div>
            
            <!-- لا توجد حجوزات -->
            <div *ngIf="day.bookings?.length === 0" class="no-bookings">
              <i class="fa fa-calendar-times-o"></i>
              <p>لا توجد حجوزات</p>
            </div>
          </div>
          
          <div class="day-footer" *ngIf="day.bookings?.length > 0">
            <span class="total-bookings">{{ day.totalBookings }} حجز</span>
            <span class="total-revenue">{{ day.totalRevenue | number:'1.0-0' }} ج.م</span>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Legend & Filters -->
  <div class="calendar-footer" *ngIf="!loading">
    <div class="row">
      <div class="col-md-8">
        <div class="booking-legend">
          <h6><i class="fa fa-key"></i> مفتاح الرموز:</h6>
          <div class="legend-items">
            <div class="legend-item">
              <span class="legend-color confirmed"></span>
              <span class="legend-text">حجز مؤكد</span>
            </div>
            <div class="legend-item">
              <span class="legend-color pending"></span>
              <span class="legend-text">قيد الانتظار</span>
            </div>
            <div class="legend-item">
              <span class="legend-color cancelled"></span>
              <span class="legend-text">ملغى</span>
            </div>
            <div class="legend-item">
              <span class="legend-color postponed"></span>
              <span class="legend-text">مؤجل</span>
            </div>
            <div class="legend-item">
              <span class="legend-color completed"></span>
              <span class="legend-text">مكتمل</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="quick-filters">
          <h6><i class="fa fa-filter"></i> فلتر سريع:</h6>
          <div class="filter-buttons">
            <button class="btn btn-sm btn-outline-primary">
              <i class="fa fa-fire"></i> الأكثر إشغالاً
            </button>
            <button class="btn btn-sm btn-outline-success">
              <i class="fa fa-line-chart"></i> الأعلى إيراداً
            </button>
            <button class="btn btn-sm btn-outline-warning">
              <i class="fa fa-exclamation-circle"></i> قيد الانتظار
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Day Details Panel -->
  <div class="day-details-panel" *ngIf="selectedDate && !loading">
    <div class="panel-header">
      <h5>
        <i class="fa fa-calendar"></i>
        تفاصيل يوم {{ selectedDate | date:'d MMMM yyyy' }}
      </h5>
      <button class="btn btn-sm btn-light" (click)="closeDayDetails()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="panel-body">
      <!-- ملخص اليوم -->
      <div class="day-summary">
        <div class="summary-item">
          <span class="summary-label">إجمالي الحجوزات:</span>
          <span class="summary-value">{{ selectedDayBookings.length }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">إجمالي الضيوف:</span>
          <span class="summary-value">{{ getTotalGuestsForSelectedDay() }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">إجمالي الإيرادات:</span>
          <span class="summary-value text-success">{{ getTotalRevenueForSelectedDay() | number:'1.0-0' }} ج.م</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">عدد الأماكن:</span>
          <span class="summary-value">{{ getTotalVenuesCount() }}</span>
        </div>
      </div>

      <!-- إحصائيات الأماكن - نظام الكروت الجديد -->
      <div class="venues-stats" *ngIf="selectedDayBookings.length > 0">
        <h6>
          <i class="fa fa-map-marker"></i>
          إحصائيات الأماكن
        </h6>
        
        <div class="venues-grid">
          <div *ngFor="let venue of getVenueBookingsCount()" 
               class="venue-stat-card"
               [ngClass]="{
                 'top-venue': venue.count === getVenueBookingsCount()[0]?.count && venue.count > 0,
                 'low-booking': venue.count <= 2
               }">
            
            <!-- رأس الكارت -->
            <div class="venue-header">
              <span class="venue-name">
                <i class="fa fa-map-marker"></i>
                {{ venue.venueName }}
              </span>
              <span class="venue-badge">
                <i class="fa fa-calendar-check-o"></i>
                {{ venue.count }} حجز
              </span>
            </div>
            
            <!-- محتوى الكارت -->
            <div class="venue-stats-content">
              <div class="venue-count">
                <span class="venue-count-label">إجمالي الحجوزات</span>
                <span class="venue-count-number">
                  {{ venue.count }}
                  <small>حجز</small>
                </span>
              </div>
              
              <div class="venue-revenue-card">
                <span class="venue-revenue-label">إجمالي الإيرادات</span>
                <span class="venue-revenue-amount">
                  <i class="fa fa-money"></i>
                  {{ venue.revenue | number:'1.0-0' }} ج.م
                </span>
              </div>
            </div>
            
            <!-- فوتر الكارت -->
            <div class="venue-stats-footer">
              <span class="venue-bookings-count">
                <i class="fa fa-users"></i>
                متوسط {{ (venue.revenue / venue.count) | number:'1.0-0' }} ج.م
              </span>
              <span class="venue-percentage">
                <i class="fa fa-pie-chart"></i>
                {{ (venue.count / selectedDayBookings.length) * 100 | number:'1.0-0' }}%
              </span>
            </div>
          </div>
        </div>
        
        <!-- ملخص سريع للأماكن - كروت صغيرة -->
        <div class="venues-summary-cards">
          <div class="summary-stat-card">
            <div class="summary-stat-icon venues">
              <i class="fa fa-map-marker"></i>
            </div>
            <div class="summary-stat-content">
              <span class="summary-stat-label">إجمالي الأماكن</span>
              <span class="summary-stat-value">{{ getTotalVenuesCount() }}</span>
              <span class="summary-stat-sub">مكان مختلف</span>
            </div>
          </div>
          
          <div class="summary-stat-card">
            <div class="summary-stat-icon bookings">
              <i class="fa fa-calendar-check-o"></i>
            </div>
            <div class="summary-stat-content">
              <span class="summary-stat-label">إجمالي الحجوزات</span>
              <span class="summary-stat-value">{{ selectedDayBookings.length }}</span>
              <span class="summary-stat-sub">حجز اليوم</span>
            </div>
          </div>
          
          <div class="summary-stat-card" *ngIf="hasMultipleVenues()">
            <div class="summary-stat-icon top">
              <i class="fa fa-trophy"></i>
            </div>
            <div class="summary-stat-content">
              <span class="summary-stat-label">الأكثر حجوزات</span>
              <span class="summary-stat-value">{{ getVenueBookingsCount()[0]?.venueName }}</span>
              <span class="summary-stat-sub">{{ getVenueBookingsCount()[0]?.count }} حجز</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- قائمة حجوزات اليوم -->
      <div class="day-bookings">
        <h6>
          <i class="fa fa-list"></i>
          الحجوزات:
        </h6>
        <div *ngFor="let booking of selectedDayBookings" 
             class="booking-card"
             (click)="goToBookingDetails(booking.bookingId)">
          <div class="booking-header">
            <span class="booking-time">{{ formatTime(booking.bookingTime) }}</span>
            <span class="booking-status" [ngClass]="getStatusClass(booking.bookingStatus)">
              {{ getStatusText(booking.bookingStatus) }}
            </span>
          </div>
          <div class="booking-body">
            <h6>{{ booking.clientName || 'غير محدد' }}</h6>
            <p>
              <i class="fa fa-users"></i> {{ booking.guestsCount || 0 }} شخص | 
              <i class="fa fa-cutlery"></i> {{ getBookingTypeText(booking.bookingType) }} |
              <i class="fa fa-map-marker"></i> 
              <span class="venue-highlight">{{ getVenueName(booking.venueId) }}</span>
            </p>
            <p *ngIf="booking.clientPhone">
              <i class="fa fa-phone"></i> {{ booking.clientPhone }}
            </p>
            <p *ngIf="booking.note" class="booking-note">
              <i class="fa fa-sticky-note"></i> {{ booking.note }}
            </p>
          </div>
        </div>
        
        <!-- لا توجد حجوزات -->
        <div *ngIf="selectedDayBookings.length === 0" class="no-bookings-message">
          <i class="fa fa-calendar-times-o fa-2x"></i>
          <p>لا توجد حجوزات في هذا اليوم</p>
        </div>
      </div>
    </div>
    
    <div class="panel-footer">
      <button class="btn btn-primary" (click)="createNewBooking(selectedDate)">
        <i class="fa fa-plus"></i> إضافة حجز جديد
      </button>
      <button class="btn btn-outline-secondary" (click)="printDayBookings(selectedDate)">
        <i class="fa fa-print"></i> طباعة اليوم
      </button>
    </div>
  </div>
</div>